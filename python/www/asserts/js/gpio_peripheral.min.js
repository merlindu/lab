function disable_select(e){if("disabled"!=$(e).attr("disabled")){$(e).attr("disabled",!0);var n=M.Select.init(e,"");n.destroy()}}function enable_select(e){if("disabled"==$(e).attr("disabled")){$(e).attr("disabled",!1);M.Select.init(e,"")}}function update_attached_dev_info(cmd,dev,chnls){XMLHttp.sendRequest("/gpio/peripheral","post","get_per_dev_status","dev="+dev,function(xmlhttp){var json=eval("("+xmlhttp.responseText+")"),elem=document.querySelector("#device_channel");disable_select(elem);for(var i=0;chnls>i;i++){var pinmux=eval("json.chn"+i);"add"==cmd&&255!=pinmux?$("#device_channel option[value="+i+"]").attr("disabled",!0):"remove"==cmd&&255==pinmux&&$("#device_channel option[value="+i+"]").attr("disabled",!0)}enable_select(elem)})}function create_device_subdivs(){var dev_option=$("#device_type"),devname=operation.device,chip_dev=eval("chip_"+devname);if("error"==chip_dev.chanls&&"error"==chip_dev.pinmuxs&&"error"==chip_dev.pins){var chanls=parseInt(dev_option.find("option:selected").attr("data-chnls"));chip_dev.chanls=chanls,chip_dev.pinmuxs=new Array(chanls),chip_dev.pins=new Array,eval("device_status."+devname+"= new Array("+chanls+")");for(var pins=dev_option.find("option:selected").attr("data-pins").split(";"),i=0;chanls>i;i++)for(eval("device_status."+devname+"["+i+"] = 0xff"),chip_dev.pinmuxs[i]=parseInt(dev_option.find("option:selected").attr("data-pinmux").split(";")[i]),chip_dev.pins[i]=new Array(chip_dev.pinmuxs[i]),j=0;j<chip_dev.pinmuxs[i];j++)chip_dev.pins[i]=pins[i]}var elem=document.querySelector("#device_channel");disable_select(elem),$("#device_channel").empty(),disable_select(document.querySelector("#device_pinmux")),$("#device_pinmux").empty(),disable_select(document.querySelector("#spi_slave")),$("#operate_confirm").css("display","none"),$("#device_channel").append('<option value="null" selected disabled>Channel</option>');for(var i=0;i<chip_dev.pins.length;i++){var pins=chip_dev.pins[i].split("**")+"",match=pins.match(new RegExp(",","g")),pinmux=match?match.length:0;$("#device_channel").append('<option value="'+i+'" data-pinmux="'+pinmux+'" data-pins="'+pins+'" data-dev="'+devname+'" data-chnls="'+i+'" data-cmd="'+operation.action+'">channel'+i+"</option>")}return update_attached_dev_info(operation.action,operation.device,chip_dev.pins.length),enable_select(elem),0}function create_channel_subdivs(e){var n=$("#device_channel"),e=n.val(),i=n.find("option:selected").attr("data-pins").split(","),a=document.querySelector("#device_pinmux");disable_select(a),$("#device_pinmux").empty(),disable_select(document.querySelector("#spi_slave")),$("#operate_confirm").css("display","none"),$("#device_pinmux").append('<option value="null" selected disabled>Pinmux</option>');for(var t=0;t<i.length-1;t++){var o=i[t]+"";o=o.replace(new RegExp("#","g"),","),$("#device_pinmux").append('<option value="'+t+'" data-pins="'+o+'" data-dev="'+operation.device+'" data-chnl="'+e+'" data-cmd="'+operation.action+'">pinmux'+t+"</option>")}return enable_select(a),0}function send_operation_to_server(){var msg="Are you sure to "+operation.action+" "+operation.device+" (chnannel"+operation.channel;if("add"==operation.action&&(msg+=", pinmux"+operation.pinmux,"spi"==operation.device&&(msg+=", "+("1"==operation.slave?"slave mode":"master mode"))),msg+=")?\n",confirm(msg)&&(msg="Please confirm again, wrong operation could well be cause system crash!",confirm(msg))){var cmd=operation.action,dev=operation.device,chnl=operation.channel,mux=operation.pinmux,is_slave=operation.slave,data="cmd="+cmd+"&dev="+dev+"&chnl="+chnl;"add"==cmd&&(data=data+"&pinmux="+mux),"spi"==dev&&(data=data+"&slave="+is_slave),XMLHttp.sendRequest("/gpio/peripheral","post","device_operate",data,function(xmlhttp){var ret=parseInt(xmlhttp.responseText)?!1:!0;if(msg=("add"==cmd?"Add":"Remove")+" device "+dev+" ( channel "+chnl,"add"==cmd&&(msg+=", pinmux "+mux,"spi"==dev&&(msg+=", "+("1"==is_slave?"slave":"master")+" mode")),msg+=" )",msg+=ret?" successfully!":"failed!",$("#result_msg").html(msg),setTimeout(function(){$("#result_msg").html("")},1500),ret){operation.action="none",disable_select(document.querySelector("#device_operate")),disable_select(document.querySelector("#device_type")),disable_select(document.querySelector("#device_channel")),$("#device_channel").empty(),disable_select(document.querySelector("#device_pinmux")),$("#device_pinmux").empty(),disable_select(document.querySelector("#spi_slave")),$("#operate_confirm").css("display","none");var pins;if("add"==cmd){pins=eval("chip_"+dev+".pins["+chnl+"]").split("**")[mux].split("#");for(var i=0;i<pins.length;i++){var name_num=pins[i].split("-");$("#pin"+parseInt(name_num[1])+" .block.pin").addClass("function"),$("#pin"+parseInt(name_num[1])+" .block.pin").text(name_num[0]+chnl)}eval("device_status."+dev+"["+chnl+"] = "+mux)}else{mux=eval("device_status."+dev+"["+chnl+"]"),pins=eval("chip_"+dev+".pins["+chnl+"]").split("**")[mux].split("#");for(var i=0;i<pins.length;i++){var name_num=pins[i].split("-");$("#pin"+parseInt(name_num[1])+" .block.pin").removeClass("function"),$("#pin"+parseInt(name_num[1])+" .block.pin").text("")}eval("device_status."+dev+"["+chnl+"] = 0xff")}}})}}function update_all_pin_status(){for(var dev=["i2c","spi","uart"],i=0;i<dev.length;i++)if(("error"!=dev[i].chanls||"error"!=dev[i].pinmuxs||"error"!=dev[i].pins)&&"string"!=typeof eval("device_status."+dev[i]))for(var chnls=eval("device_status."+dev[i]).length,j=0;chnls>j;j++){var mux=eval("device_status."+dev[i]+"["+j+"]"),all_pins=eval("chip_"+dev[i]+".pins["+j+"]").split("**")[mux],name_num=all_pins.split("#").split("-");255!=mux&&($("#pin"+parseInt(name_num[1])+" .block.pin").addClass("function"),$("#pin"+parseInt(name_num[1])+" .block.pin").text(""))}}var operation={action:"error",device:"error",channel:"error",pinmux:"error",slave:"error"},chip_i2c={chanls:"error",pinmuxs:"error",pins:"error"},chip_spi={chanls:"error",pinmuxs:"error",pins:"error",is_slave:"error"},chip_uart={chanls:"error",pinmuxs:"error",pins:"error"},device_status={i2c:"error",spi:"error",uart:"error"};$(document).ready(function(){var e=$("#operate_confirm");e.css("display","none"),update_all_pin_status(),$("#device_operate").change(function(){var n=$(this).val();if(n!=operation.action){disable_select(document.querySelector("#device_channel")),$("#device_channel").empty(),disable_select(document.querySelector("#device_pinmux")),$("#device_pinmux").empty(),disable_select(document.querySelector("#spi_slave")),e.css("display","none"),operation.action=n,operation.device="none",operation.channel="none",operation.pinmux="none",operation.slave="none";var i=document.querySelector("#device_type");disable_select(i),$("#device_type").val("null"),enable_select(i)}$("#device_chnl_div").empty()}),$("#device_type").change(function(){var e=$(this).val();if(e!=operation.device&&(operation.device=e,operation.channel="none",operation.pinmux="none",operation.slave="none","i2c"==e||"spi"==e||"uart"==e)){create_device_subdivs()}}),$("#device_channel").change(function(){var n=$(this).val();if(n!=operation.channel){if(operation.channel=n,operation.pinmux="none",operation.slave="none","remove"!=operation.action)return create_channel_subdivs();$("#operate_confirm button").text("confirm "+operation.action),"none"==e.css("display")&&e.css("display","block")}}),$("#device_pinmux").change(function(){var n=$(this).val();if(n!=operation.pinmux){if(operation.pinmux=n,operation.slave="none","spi"==operation.device){var i=document.querySelector("#spi_slave");return void enable_select(i)}$("#operate_confirm button").text("confirm "+operation.action),"none"==e.css("display")&&e.css("display","block")}}),$("#spi_slave").change(function(){var n=$(this).val();n!=operation.slave&&(operation.slave=n,$("#operate_confirm button").text("confirm "+operation.action),"none"==e.css("display")&&e.css("display","block"))}),$("#operate_confirm button").click(send_operation_to_server),$("#active_operate").click(function(){var e=document.querySelector("#device_operate");enable_select(e)})});